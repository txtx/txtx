name: CI
on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

  workflow_dispatch:

jobs:
  pre_run:
    name: Cancel previous runs
    runs-on: ubuntu-latest
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@ad6cb1b847ffb509a69b745b6ee2f1d14dfe14b8
        with:
          access_token: ${{ github.token }}
          persist-credentials: false
  wasm_build:
    name: Build Project for WASM target
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        run: |
          rustup toolchain install stable --profile minimal --target wasm32-unknown-unknown
          rustup target add wasm32-unknown-unknown
          echo "RUST_VERSION_HASH=$(rustc --version | sha256sum | awk '{print $1}')" >> $GITHUB_ENV

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/
            ./target/wasm32-unknown-unknown/release/
          key: ${{ runner.os }}-rust-${{ env.RUST_VERSION_HASH }}-cargo-${{ hashFiles('./Cargo.lock') }}

      - name: Build WASM for txtx-vm
        run: cargo build --package txtx-vm --release --locked --target wasm32-unknown-unknown --features wasm

      - name: Build WASM for txtx-ext-kit
        run: cargo build --package txtx-ext-kit --release --locked --target wasm32-unknown-unknown --features wasm

      - name: Build WASM for txtx-ext-ethereum
        run: cargo build --package txtx-ext-ethereum --release --locked --target wasm32-unknown-unknown --features wasm