# Test Setup Structure

## How Tests Work

When a test runs using `ProjectTestHarness`, it creates a complete txtx project in a temporary directory:

### 1. Project Structure Created

```
temp_dir/
├── txtx.yml                      # Generated by ProjectTestHarness
├── runbooks/
│   ├── test.tx                   # The test runbook (copied from fixtures)
│   └── signers.testing.tx        # Generated signer configuration
├── contracts/                    # Contract source files (if needed)
└── out/ (or artifacts/)          # Compilation outputs
    └── SimpleStorage.json        # Contract artifacts
```

### 2. txtx.yml Generation

The `ProjectTestHarness::create_txtx_yml()` method generates:

```
name: Test Project
description: Test project for EVM addon
runbooks:
- name: test.tx
  location: "./runbooks/test.tx"
  signers_location: "./runbooks/signers.testing.tx"
environments:
  testing:
    rpc_url: "http://127.0.0.1:8545"      # From Anvil
    sender_private_key: "0xac097..."      # From inputs
    deployer_private_key: "0xac097..."    # From inputs
```

### 3. Signers Configuration

The `signers.testing.tx` file is generated with:

```hcl
signer "sender_signer" "evm::secret_key" {
    secret_key = input.sender_private_key
}

signer "deployer" "evm::secret_key" {
    secret_key = input.deployer_private_key
}
```

This references the `input.sender_private_key` which comes from the `testing` environment in txtx.yml.

### 4. Test Execution Flow

1. **Test creates harness:**
   ```rust
   let harness = ProjectTestHarness::new_foundry_from_fixture("test.tx")
       .with_anvil()
       .with_input("sender_private_key", ANVIL_KEY_0);
   ```

2. **Harness setup:**
   - Creates temp directory
   - Generates txtx.yml with environment
   - Creates signers.testing.tx
   - Copies test runbook
   - Sets up contract artifacts

3. **Runbook execution:**
   - txtx-core loads txtx.yml
   - Finds runbook and signers
   - Uses `testing` environment
   - Executes actions

## Key Points

- **txtx.yml is generated per test** - Not a static fixture
- **Environment is always "testing"** - Configured in generated txtx.yml
- **Signers use input values** - From the environment configuration
- **Inputs flow:** Test → ProjectTestHarness → txtx.yml → environment → signers

## Example Test

```rust
#[test]
fn test_eth_transfer() {
    // Create harness with runbook
    let harness = ProjectTestHarness::new_foundry_from_fixture(
        "integration/simple_send_eth.tx"
    )
    .with_anvil()  // Spawns Anvil, adds RPC URL to inputs
    .with_input("sender_private_key", ANVIL_KEYS[0])
    .with_input("sender_address", ANVIL_ACCOUNTS[0])
    .with_input("recipient_address", ANVIL_ACCOUNTS[1]);
    
    // Setup creates txtx.yml, signers.testing.tx, etc.
    harness.setup().unwrap();
    
    // Execute through txtx-core
    let result = harness.execute_runbook().unwrap();
    
    assert!(result.outputs.contains_key("tx_hash"));
}
```

The test runbook (`simple_send_eth.tx`) can then use:
- `input.sender_address` - from harness inputs
- `signer.sender_signer` - from generated signers.testing.tx
- `input.rpc_url` - from Anvil configuration